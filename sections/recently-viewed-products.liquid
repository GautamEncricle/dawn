<div id="recently-viewed-products" class="recently-viewed-wrapper">
  {% if section.settings.heading != blank %}
    <h2 class="recently-viewed-title">{{ section.settings.heading }}</h2>
  {% endif %}

  <div class="product-list">
    {% comment %} Placeholder — JS will inject product HTML here {% endcomment %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const viewedProducts = JSON.parse(localStorage.getItem('recentlyViewed') || '[]');
    console.log('this is from recently-viewed-products');
    console.log(viewedProducts);

    if (viewedProducts.length > 0) {
      const productListContainer = document.querySelector('#recently-viewed-products .product-list');
      let productsHTML = '';

      viewedProducts.forEach(function (handle) {
        await fetch(`/products/${handle}.js`) // Fetch the product data in JSON format
          .then((response) => response.json())
          .then((product) => {
            // Format the price in the store's currency
            const formattedPrice = formatMoney(product.price / 100); // Divide by 100 to get dollars if price is in cents

            const productHTML = `
              <div class="product-item">
                <a href="${product.url}" class="product-link">
                  <img
                    src="${product.featured_image}"
                    alt="${product.title}"
                    class="product-image"
                    width="300"
                    height="300"
                  >
                  <h3 class="product-title">${product.title}</h3>
                  <p class="product-price">${formattedPrice}</p>
                </a>
              </div>
            `;
            productsHTML += productHTML; // Append each product's HTML to the list

            // Once all products are fetched, insert them into the product-list
            if (viewedProducts.indexOf(handle) === viewedProducts.length - 1) {
              productListContainer.innerHTML = productsHTML;
            }
          })
          .catch((error) => console.error('Error fetching product data:', error));
      });
    } else {
      document.querySelector('#recently-viewed-products').innerHTML = '<p>No recently viewed products found.</p>';
    }
  });

  // Function to format money (price)
  function formatMoney(price) {
    const currencySymbol = Shopify.currency.active === 'USD' ? '$' : '€'; // Example, customize per currency
    return `${currencySymbol} ${price.toFixed(2)}`;
  }
</script>

{% schema %}
{
  "name": "Recently Viewed Products",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Recently Viewed"
    }
  ],
  "presets": [
    {
      "name": "Recently viewed products",
      "category": "Products"
    }
  ]
}
{% endschema %}
